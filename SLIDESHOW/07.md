Mako Basics <span style="float:right;">[&#x25C0;](06.md) [&#x25B2;](../README.md) [&#x25BA;](08.md)</span>
=========

The __mako_basics_favorite_color.mako__ (*[source code](https://github.com/BrentNoorda/django_unusual/blob/master/django_unusual/mako/examples/mako_basics_favorite_color.mako]())*) page demonstrates the primary (in my opinion) uses of mako.

* ["${...}" expression substition (with escaping)](#subst)
* ["% ...control code..." python code lines](#control)
* ["<% ... %>" embedded blocks of python](#block)
* ["<!% ... %>"module-level blocks of python](#module)
* ["<%include file='...' args='...'/>" and "<%page args='...'/>"](#include)

---------------------

<a name="subst"/>
## "${...}" expression substition (with escaping)

Anywhere that __${expression}__ appears in HTML will be replaced with a text result of that expression. __expression__ may also be followed with an escape expression (e.g. "| h") for HTML rendering.

For example, __mako_basics_favorite_color.mako__ contains this code which print the value of the _popular_color_ variable, escaping any weird characters (such as "&" in "black&blue"):

    <p>The most popular color is ${ popular_color | h }</p>

And this example fills another cell with a link, substituting many variables and expressions:

    <td style="background-color:${ rgbattr(v['rgb'] )}">
        <a href="./mako_basics_favorite_color.mako?favorite=${ name | u}" style="color:${rgbattr(v['rgb'] ^ 0xFFFFFF)}">
            ${ name | h}
        </a>
    </td>

<a name="control"/>
## "% ...control code..." python code lines

Any line whose first non-blank character is "%" is a single line of python control code. Usually this is control code (e.g. _if_, _for_, etc...) and the block must end with a matching _% end.._ (e.g. _% endif_, % endfor_, etc...)

__mako_basics_favorite_color.mako__ has this _%if_ example:

    % if popular_color is not None:
        <p>The most popular color is ${ popular_color | h }</p>
    % endif

and this _% for_ code

    % for name,v in gColors.items():
        ... a bunch of code here that can use the "name" and "v" variables ...
    % endfor

<a name="block"/>
## "<% ... %>" embedded blocks of python

Any python code can be embedded between __<%...%>__ tags, and will execute within that spot of the html, using varibles, creating variables, causing havoc, etc...

For example, __mako_basics_favorite_color.mako__ contains this code block within the _%for_ loop mentioned previously:

    % for name,v in gColors.items():
        ... lots of code ...
        <%
            if (popular_color is None) or (gColors[popular_color]['votes'] < v['votes']):
                popular_color = name
        %>
        ... more code ...
    % endfor

It is common to have such a block near the top of the mako file, to evaluate the request object, verify user rights (maybe httpredirect and _return_ if there was a violation), and so on.

This is the code in __mako_basics_favorite_color.mako__ that initializes a variable and checks if the user entered a favorite color:

    <%
        popular_color = None

        previous_favorite = get_previous_favorite(request)

        if 'favorite' in request.GET:
            favorite_color = request.GET['favorite']
            gColors[favorite_color]['votes'] += 1    # this is bad code because of global stuff
            set_previous_favorite(request,favorite_color)
        else:
            favorite_color = None
    %>

<a name="module"/>
## "<!% ... %>"module-level blocks of python

Code within __<%!...%>__ tags is module-level. It is loaded just once when the template is loaded into memory (sort of like combining imported libraries within the template itself).

Most commonly your _import_ statements will be here, along with python functions that the rest of the mako file will use.

Note that this is not per-instance code, and so will not have access to the _request_, _response_, and _logger_ variables that I passed into each instance unless those are parameters to the function.

This subset of __mako_basics_favorite_color.mako__ demonstrates these uses:

    <%!
        import datetime

        def rgbattr(rgb):   # return HTML friendly version of color
            ret = '%X' % (rgb & 0xFFFFFF)
            while len(ret) < 6:
                ret = '0' + ret
            return '#' + ret

        def set_previous_favorite(request,favorite_color):
            request.session['favorite_color'] = favorite_color
    %>

There is other code in this module-level block of __mako_basics_favorite_color.mako__ that uses global variables. Globals can be OK if its a read-only field, for example the non-votes part of this:

    gColors = { # list colors and their RGB value
        'red' :       { 'rgb':0xFF0000, 'votes': 0 }, # votes will be seen as a bad idea
        'green':      { 'rgb':0x00FF00, 'votes': 0 },
        'blue':       { 'rgb':0x0000FF, 'votes': 0 },
        'black':      { 'rgb':0x000000, 'votes': 0 },
        'white':      { 'rgb':0xFFFFFF, 'votes': 0 },
        'yellow':     { 'rgb':0xFFFF00, 'votes': 0 },
        'purple':     { 'rgb':0xFF00FF, 'votes': 0 },
        'black&blue': { 'rgb':0x000099, 'votes': 0 },
    }

global variables might also be OK for caching, for example something like this:

    cached_canary_wikipedia_page = None

    def get_canary_wikipedia_page():
        if cached_canary_wikipedia_page is None:
            cached_canary_wikipedia_page = slow_function_that_reads_from_wikipedia('canary')
        return cached_canary_wikipedia_page

but in __mako_basics_favorite_color.mako__ there are very bad uses of globals, both for keeping a global _visitor_count_ and for tracking those _votes_

writable globals are bad because:

* writeable globals will be reset when this template is reloaded (e.g. server restart)
* writeable globals assume this server is only one process, with one "thread", on one server (more on this later)

<a name="include"/>
## "<%include file='...' args='...'/>" and "<%page args='...'/>"

Very useful for HTML that is common across many pages. E.G.

* common headers, footers
* common means to #include js, css, images

args are optional

in __mako_basics_favorite_color.mako__ the footer is included with:

    <%include file="example_footer.include" args="allRights=False"/>

and _example_footer.include_ is this mako file:

## common footer in our example pages - this could be any mako code

    <%page args="allRights=True"/>

    <div style="background-color:#ccc;width:100%;padding:3px 10px 3px 10px;">
        Copyright 2013 Salmonella Enterprises<br/>
        % if allRights:
            All Rights Preserved<br/>
        % else:
            We Reserve the Right to Serve Refuse to Anyone
        % endif
        <br/><a href="/">Home</a>
    </div>



------

&nbsp;&nbsp;&nbsp;&nbsp; [&lt;&lt; prev](06.md) -- [top](../README.md) -- [next &gt;&gt;](08.md)