timeout to make our code sane <span style="float:right;">[&#x25C0;](21.md) [&#x25B2;](../README.md) [&#x25BA;](23.md)</span>
=========

Convert [favorite_color_with_temperature.mako](https://github.com/BrentNoorda/django_unusual/blob/master/django_unusual/mako/examples/favorite_color_with_temperature.mako) to [favorite_color_with_temperature_and_db.mako](https://github.com/BrentNoorda/django_unusual/blob/master/django_unusual/mako/examples/favorite_color_with_temperature_and_db.mako) because it was crazy to be storing all that stuff in-memory.

*Warning: this page is boring*

### 1) define DB files

* [models.py](https://github.com/BrentNoorda/django_unusual/blob/master/django_unusual/models.py) - define the _ColorTemp_ and _Crash_ table models
* [sql/colortemp.sql](https://github.com/BrentNoorda/django_unusual/blob/master/django_unusual/sql/colortemp.sql) - make the id field rollover when it gets too big, and override default handing of datetime setup (I __hate__ not using UTC)
* [sql/crash.sql](https://github.com/BrentNoorda/django_unusual/blob/master/django_unusual/sql/crash.sql) - override default handing of datetime setup (I __hate__ time zones)

### 2) add "django_unusual" APP

add "django_unusual" to _INSTALLED_APPS_ in [settings.py](https://github.com/BrentNoorda/django_unusual/blob/master/django_unusual/settings.py)

### 3) Initialize DB

    # python manage.py syncdb

### 4) create [favorite_color_with_temperature_and_db.mako](https://github.com/BrentNoorda/django_unusual/blob/master/django_unusual/mako/examples/favorite_color_with_temperature_and_db.mako)

Alter [favorite_color_with_temperature.mako](https://github.com/BrentNoorda/django_unusual/blob/master/django_unusual/mako/examples/favorite_color_with_temperature.mako) as [favorite_color_with_temperature_and_db.mako](https://github.com/BrentNoorda/django_unusual/blob/master/django_unusual/mako/examples/favorite_color_with_temperature_and_db.mako) to properly use DB for permanance across time and reboots and processes.

For live demo, execute here: __[http://MY_IP_ADDRESS:8000/examples/favorite_color_with_temperature_and_db.mako](http://MY_IP_ADDRESS:8000/examples/favorite_color_with_temperature_and_db.mako)__

remove the extra delay
but add occasional crashing

gevent.spawn() is a quick way to launch a greenlet to run separately

I altered [favorite_color_with_temperature.mako](https://github.com/BrentNoorda/django_unusual/blob/master/django_unusual/mako/examples/favorite_color_with_temperature.mako) to [favorite_color_with_temperature_spawned.mako](https://github.com/BrentNoorda/django_unusual/blob/master/django_unusual/mako/examples/favorite_color_with_temperature_spawned.mako) in these ways:

* run the slow (~5 second) get-temperature routine separately
* return response immediately (not waiting for temperature to display)
* accept that the response won't contain that most recent data
* this now requires that greenlets be running

Code changed from this:

    <%!
        ...
    %>
    <%
        ...
            favorite_color = request.GET['favorite']
            current_temperature = lib.oakland_weather.get_current_oakland_weather(extra_delay=5,default=72)
            gColors[favorite_color]['temperatures'].append(current_temperature)
        ...
    %>

to this:

    <%!
        import gevent
        ...
        def correlate_temperature_with_color(favorite_color):
            current_temperature = lib.oakland_weather.get_current_oakland_weather(extra_delay=5,default=72)
            gColors[favorite_color]['temperatures'].append(current_temperature)
    %>
    <%
        ...
            favorite_color = request.GET['favorite']
            gevent.spawn(correlate_temperature_with_color,favorite_color)
        ...
    %>


### Results

*if running live see __[http://MY_IP_ADDRESS:8000/examples/favorite_color_with_temperature_spawned.mako](http://MY_IP_ADDRESS:8000/examples/favorite_color_with_temperature_spawned.mako)__*

* page returns immediately
* still takes 5 seconds to get temperature, so totals on page may be behind values

(*note, don't code like [favorite_color_with_temperature_spawned.mako](https://github.com/BrentNoorda/django_unusual/blob/master/django_unusual/mako/examples/favorite_color_with_temperature_spawned.mako). it's yucky*)

------

&nbsp;&nbsp;&nbsp;&nbsp; [&lt;&lt; prev](21.md) -- [top](../README.md) -- [next &gt;&gt;](23.md)